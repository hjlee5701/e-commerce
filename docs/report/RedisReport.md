# Reids 적용 보고서
# 인기 상품 조회 Redis 적용 보고서
## 1. 3일간 인기 상품 조회
### 1. 개요
- 3일 인기상품 집계는 스케줄러가 매일 전날까지의 일별 데이터를 배치 방식으로 합산해 랭킹을 생성한다.
  - 매일 0시 15분에 스케줄러가 전날 데이터를 집계하며 전날 기준 3일 전까지의 일별 키를 합산한 3일 인기 상품 랭킹을 생성한다.
  - 인기 상품 결과는 Redis에 캐싱되며 TTL(유효기간)이 설정되어 있다.
  - 일별 집계 데이터와 통합 랭킹은 모두 Redis에 관리된다.


### 2. 구현 상세

   2-1. 인기 상품 집계
   - 주문 데이터 수집 및 집계
       - 스케줄러에서 전날 날짜 기준 3일 전까지의 일별 키와 `ZUNIONSTORE` 명령으로 합산한다.
          ```bash
          ZINCRBY key quantity productId
          EXPIRE key 259200   # (3일 = 259200초)
          ```
       - 합산된 결과는 3일간 유효한 랭킹 키에 저장된다.
       - 전일 기준 Redis Sorted Set 에 전날 통계를를 생성한다.
       - Redis `ZINCRBY` 명령어를 활용하며, 키 TTL은 3일로 설정해 자동 만료를 관리한다.
         ```bash
           ZINCRBY product:ranking:daily:20250515 5 123
           EXPIRE product:ranking:daily:20250515 259200
         ```
    
2-2. 캐싱
- 인기 상품 랭킹 조회 시 @Cacheable 애노테이션을 활용해 3일간 인가상품 정보를 Redis 캐시에 저장한다.


### 3. 결론
   - 3일 인기상품은 안정적인 배치 집계로 데이터 신뢰성 보장 
   - Redis ZSet를 활용해 효율적인 정렬 및 조회가 가능하며, TTL 관리로 데이터 자동 정리가 가능하다. 
   - 캐시를 통해 인기 상품 조회 성능을 최적화하고, 필요에 따라 TTL 조절이 가능하다.
   

## 2. 실시간 인기 상품 조회
### 1. 개요
   - 실시간 인기상품 집계는 결제 이벤트 발생 즉시 Redis에 판매량 데이터를 누적해 즉각적인 랭킹 반영을 목표로 한다.


### 2. 구현 상세

    2.1 실시간 인기상품 데이터 적재 (현재 구현 완료)
      - 결제 완료 후 paidProductAggregateWithRedis 메서드가 비동기로 호출되어 Redis의 실시간 ZSet에 상품별 판매량을 누적한다.
      - (`ZINCRBY` 명령어 활용)
    
    2.2 실시간 인기상품 집계 (미구현)
    - 현재는 실시간 판매량 누적 데이터 적재까지만 완성된 상태이다.


### 3. 결론 및 향후 계획
   - 실시간 인기상품 적재 분리로 시스템 간 간섭 최소화 및 운영 유연성을 확보한다.
   - 향후 실시간 랭킹 산출 및 캐싱, 조회 API 연동 등 집계 기능을 추가 구현할 계획이다.

---
## 선착순 쿠폰 발급 Redis 적용 보고서
### 1. 개요
- 매일 스케줄러가 쿠폰 발급 대기 중인 회원을 순차적으로 처리하며, 쿠폰 발급 상태는 Redis에서 관리된다.
- 발급 대상 회원은 Redis의 대기열에 추가되며, 중복 발급을 방지하기 위해 발급된 회원은 Redis의 상태 관리 시스템을 통해 추적된다.
- 발급된 쿠폰은 데이터베이스에 저장되며, 쿠폰 발급 후 대기열에서 제거된다.

### 2. 구현 상세
2.1. 쿠폰 발급 프로세스
- 쿠폰 요청 대기열 관리:
  - 쿠폰 요청이 발생하면, 해당 쿠폰에 대한 회원들은 Redis의 ZSET 자료구조에 대기열로 추가된다.
  - 각 회원의 ID는 COUPON_REQUEST_ZSET 키에 저장되며, 해당 회원의 요청 시각(타임스탬프)은 score로 기록된다.
  - 이로 인해 요청 순서가 자동으로 정렬되며, 선착순 처리가 용이해진다.
- 발급 상태 관리:
  - 쿠폰이 발급될 때마다, Redis의 SET 자료구조에 발급된 회원 ID를 기록하여 중복 발급을 방지한다.
  - COUPON_ISSUED_SET 키를 사용하여 이미 발급된 회원을 추적하고, 중복된 회원이 발견되면 발급을 진행하지 않는다.
- 쿠폰 발급 및 상태 체크:
  - processCoupon 메서드는 쿠폰의 남은 수량이 0이 될 때까지 대기열에 있는 회원에게 순차적으로 쿠폰을 발급한다.
  - 최대 20명까지 발급되며 이미 발급된 경우 중복을 방지하고 대기열에서 해당 회원을 제거한다.
  - 발급이 성공적으로 처리되면, 해당 회원에 대한 발급 내역을 couponItem으로 DB에 저장한다.

2.2. 스케줄러 설정
- 스케줄러 관리: 매분 자동으로 실행되는 스케줄러(issueCoupon 메서드)를 통해 발급 가능한 쿠폰들을 조회하고, 각 쿠폰에 대해 processCoupon 메서드를 호출하여 발급을 처리한다. 이를 통해 시스템은 자동화된 발급을 보장하며, 대기 중인 회원들을 순차적으로 처리한다.

2.3. 중복 방지
- 중복 확인 및 처리: isDuplicate 메서드를 사용하여 발급 상태를 체크하고, 이미 쿠폰을 받은 회원은 중복 발급을 방지하기 위해 대기열에서 제거된다. 이 과정에서 중복된 회원을 자동으로 제외하고 발급을 진행하지 않으며, 대기열에서 해당 회원을 삭제하여 처리한다.

### 3. 결론
- Redis를 활용한 선착순 쿠폰 발급 시스템은 높은 효율성과 실시간 처리가 가능하며, 기존의 DB 기반 처리보다 빠르고 안정적인 발급 환경을 제공
- Redis의 ZSET과 SET 자료구조를 활용하여 쿠폰 발급 대기열과 발급 상태를 관리함으로써, 중복 발급을 방지하고, 효율적인 데이터 처리가 가능
- 향후 다양한 정책을 추가하여 쿠폰 발급 기능을 확장 가능. (예를 들어, 특정 시간대에만 발급되는 쿠폰이나 특정 회원군에게만 발급되는 쿠폰을 구현)